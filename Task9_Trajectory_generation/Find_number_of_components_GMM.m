%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% MATLAB SCIPT TO FIND THE BEST SUITING GMM FOR GIVEN (Q,QDOT) BASED ON THE
% AIC AND BIC METRICS
%
% Last edition: 21.12.2021
% Author: Raphael Uebersax
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear all;
close all;
clc;

addpath("../Tools");
addpath("../Regressors");
addpath("./Task9_tools");
rng('default');


%% 0) Variables and constraints

% Select one task
Task = "Polar_DS";      
%Task = "Linear_DS";


%% 1) Import results from data folder

if strcmp(Task,"Linear_DS")
    data_q = load("data/Linear_DS_qs.mat");
    data_q = data_q.data_q;
    data_x = load("data/Linear_DS_xs.mat");
    data_x = data_x.data_x;
        
    
elseif strcmp(Task,"Polar_DS")
    data_q = load("data/Polar_DS_qs.mat");
    data_q = data_q.data_q;
    data_x = load("data/Polar_DS_xs.mat");
    data_x = data_x.data_x;
    
end





%% 2) Get GMM modelling for different combinaison of hyperparams

% Parameters than want to be tested
k = 1:15;                                % Number of components
nK = numel(k);                          
RegularizationValue = 0.01;             % Regularization value to ensure postive Covariance
options = statset('MaxIter',10000);     % Increase number of max iterations

% Preallocation using cells
gm = cell(nK,1);           % GMM models   
aic = zeros(nK,1);         % AIC criteria
bic = zeros(nK,1);         % BIC criteria
converged = false(nK,1);   % Bool flag if the GMM has converged

% Fit all models

for i = 1:nK
    gm{i,1} = fitgmdist(data_q, k(i),...
        'CovarianceType','full',...
        'RegularizationValue',RegularizationValue,...
        'Options',options);
    aic(i,1) = gm{i,1}.AIC;
    bic(i,1) = gm{i,1}.BIC;
    converged(i,1) = gm{i,1}.Converged;
end

% Verify that all GMM models have converged
allConverge = (sum(converged(:)) == nK);
disp("All have converged: "+string(allConverge));

%%
% Display AIC curve
figure
plot(k,aic,'--o')
hold on
plot(k,bic,'--o')
title('GMM (full) Model Fitting Evalution Metrics','Interpreter','latex')
xlabel('$k$','Interpreter','Latex')
legend({'AIC','BIC'})
xticks(k)

