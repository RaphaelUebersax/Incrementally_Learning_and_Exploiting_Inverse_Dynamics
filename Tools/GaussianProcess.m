%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% MATLAB SCIPT TO COMPUTE THE GAUSSIAN PROCESS REGRESSION WITH PRIOR
% KNOWLEDE ABOUT THE IDEAL RBD FOR JOINT NUMBER 2
%
% Last edition: 10.10.2021
% Author: Raphael Uebersax
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
clear all;
close all;
clc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% VARIABLES TO SET BEFORE RUNNING THE SCRIPT !!!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Choose if loading small data set or take new data from complete set
small_dataset = false;   % Set to true if using preexisting file
N = 1000;                % number of data rows to load if from complete set
M = 500;                 % number of data rows to add to test without train
n_steps = 20;            % Set intervall between two successive datapoints

% Choose parameters for the GPR learning method
train_test_ratio = 0.3;

% Choose if comparing GPR with prior to without
comparison = true;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




% import iiwa14 robot tree from urdf file
robot = importrobot('../data/iiwa14.urdf');
robot.DataFormat = "row";
robot.Gravity = [0,0,-9.81];

% Name of complete and small data file
small_filename = '../data/gprProcessedActualData.csv';
filename = '../../Complete_data/processedActualData.csv';


%% Load the data from complete data file (only run the 1st time)

% Load the N first rows of the data from csv file (exluding time)
% pos 1-7 | dpos 1-7 | ddpos 1-7 | torque 1-7

if (small_dataset == false)
    data = csvread(filename,1,1,[1,1,N*n_steps,28]); % Variable containing the data
    data = data([1:n_steps:end],:);

    % Load data afterwards seperatly to only include in the test 
    data_away = csvread(filename,N*n_steps+1,1,[N*n_steps+1,1,N*n_steps+M*n_steps,28]); % Variable containing the data
    data_away = data_away([1:n_steps:end],:); 

    % write smaller dataset into a csv file
    data_to_write = [data',data_away']';   % complete dataset
    delimitation = size(data,1);           % information on seperation between data and data_away
    delimitation_vector = delimitation*ones(size(data_to_write,1),1);
    data_to_write = [data_to_write,delimitation_vector];
    
    if exist(small_filename, 'file')==2
      delete(small_filename);             % delete old file if exists
    end
    writematrix(data_to_write,small_filename);
    
else
    if isfile(small_filename)
         data_complete = readmatrix(small_filename);
         data = data_complete(1:data_complete(1,29),1:28);
         data_away = data_complete(data_complete(1,29):end, 1:28);
    else
         error('Small dataset not found');
    end
end




%% Split the data into train and test set

% Assign variables to train and test sets
index_plot = [1:size(data,1)];  % keep track of data position for plots
data = [data, index_plot'];
cv = cvpartition(size(data,1),'HoldOut',train_test_ratio);
idx = cv.test;


% Separate to training and test data
dataTrain = data(~idx,:);
dataTest  = data(idx,:);

train_X =  dataTrain(:,1:14);
train_y = dataTrain(:,23);
test_X = [dataTest(:,1:14);data_away(:,1:14)];
test_y = [dataTest(:,23);data_away(:,23)];

% Keep track of index for plots
x_plot_train = dataTrain(:,29);
x_plot_test_1 = dataTest(:,29);
x_plot_test_2 = [(size(data,1)+1):(size(data,1)+size(data_away,1))]';
x_plot_test = [x_plot_test_1', x_plot_test_2']';

% Training joint parameters for RBD
train_joint_pos = train_X(:,1:7);                % Joint Position   
train_joint_vel = train_X(:,8:14);               % Joint Velocity
train_joint_acc = zeros(size(train_X,1),7);      % Joint Acceleration
   
% Testing joint parameters for RBD
test_joint_pos = test_X(:,1:7);                  % Joint Position   
test_joint_vel = test_X(:,8:14);                 % Joint Velocity
test_joint_acc = zeros(size(test_X,1),7);        % Joint Acceleration



%% Computation of ideal RBD from robot model 

% initialize vector of correct size
train_RBD = zeros(size(train_X,1),7);
test_RBD = zeros(size(test_X,1),7);

% ideal inverse dynamics of the robot for using it as the mean for train
for i=1:size(train_X,1)
    train_RBD(i,:) = inverseDynamics(robot,train_joint_pos(i,:), ...
        train_joint_pos(i,:), train_joint_acc(i,:));
end

% ideal inverse dynamics of the robot for using it as the mean for test
for i=1:size(test_X,1)
    test_RBD(i,:) = inverseDynamics(robot,test_joint_pos(i,:), ...
        test_joint_pos(i,:),test_joint_acc(i,:));
end

% Inverse the torque value from measured to exercing
train_RBD = -1*train_RBD;
test_RBD = -1*test_RBD;

% Load values for joint 2 only
train_RBD_joint2 = train_RBD(:,2);
test_RBD_joint2 = test_RBD(:,2);



%% Gaussian Process Regression with prior knowledge OWN IMPLEMENTATION
Sigma_n = 9.16;
Sigma_rbf = 2.19;
Sigma_f = 12.5675;


tic
myGPR = GPRegressor(Sigma_rbf,Sigma_n, Sigma_f);
myGPR = myGPR.fit(train_X, train_y, train_RBD_joint2);
ypred_train = myGPR.predict(train_X, train_RBD_joint2);
ypred_test = myGPR.predict(test_X, test_RBD_joint2);
toc





%% Gaussian Process Regression with prior knowledge MATLAB

% Change the target to be z =(y-m(x)) to be able to adapt the GPR model
% The resulting torque is thus torque y = z + m(x) where m(x) is the RBD
train_z = train_y - train_RBD_joint2;

% Fiting the GPR on the training data with RBF kernel 
gprMdl = fitrgp(train_X, train_z','KernelFunction','squaredexponential','ConstantSigma',true);

% IF ADDITION OPTIMIZATION OF HYPERPARAMETERS IS REQUIRED
% gprMdl = fitrgp(train_X, train_z','KernelFunction','squaredexponential',...
%         'OptimizeHyperparameters','auto','HyperparameterOptimizationOptions',...
%         struct('AcquisitionFunctionName','expected-improvement-plus'));


% Predict target z using the previously trained GPR model
zpred_train = resubPredict(gprMdl);
zpred_test = predict(gprMdl, test_X);

% Convert the predicted z value to the torque y = z + m(x)
ypred_train2 = zpred_train + train_RBD_joint2;
ypred_test2 = zpred_test + test_RBD_joint2;


%% GPR without prior knowledge
 if comparison == true
    gprMdl_2 = fitrgp(train_X, train_y','KernelFunction','squaredexponential');
    
    % Predict target z using the previously trained GPR model
    ypred_train_trad = resubPredict(gprMdl_2);
    ypred_test_trad = predict(gprMdl_2, test_X);
 end


%% Plotting results

% Sort the data that need to be plotted
[x_plot_train_sorted, idx_train] = sort(x_plot_train);
ypred_train_sorted = ypred_train(idx_train);
train_RBD_joint2_sorted = train_RBD_joint2(idx_train);
if comparison == true
    ypred_train_trad_sorted = ypred_train_trad(idx_train);
end

% Plot result of the GPR on the train data
figure
plot(x_plot_train, train_y,'b.');
hold on;
plot(x_plot_train_sorted, ypred_train_sorted, 'r');
plot(x_plot_train_sorted, train_RBD_joint2_sorted, 'k');
if comparison == true
    plot(x_plot_train_sorted, ypred_train_trad_sorted, 'm');
    legend('Data','GPR with prior', 'ideal RBD', 'GPR without prior');
else
    legend('Data','GPR predictions', 'ideal RBD');
end
xlabel('Data number');
ylabel('Torque');
title('GPR on training set')
savefig('GPRTrainingSet.fig')
hold off


% Sort the data that need to be plotted
[x_plot_test_sorted, idx_test] = sort(x_plot_test);
ypred_test_sorted = ypred_test(idx_test);
test_y_sorted = test_y(idx_test);
test_RBD_joint2_sorted = test_RBD_joint2(idx_test);
if comparison == true
    ypred_test_trad_sorted = ypred_test_trad(idx_test);
end

nn = size(dataTest,1);
% Plot result of the GPR on the train data
figure
plot(x_plot_test_sorted(1:nn), test_y_sorted(1:nn),'b.');
hold on;
plot(x_plot_test_sorted(nn+1:end), test_y_sorted(nn+1:end),'g.');
plot(x_plot_test_sorted, ypred_test_sorted, 'r');
plot(x_plot_test_sorted, test_RBD_joint2_sorted, 'k'); 
if comparison == true
    plot(x_plot_test_sorted, ypred_test_trad_sorted, 'm');
    legend('Data in training range','Data away','GPR with prior', 'ideal RBD', 'GPR without prior');
else
    legend('Data in training range','Data away','GPR predictions', 'ideal RBD');
end

xlabel('Data number');
ylabel('Torque');
title('GPR on testing set')
savefig('GPRTestingSet.fig')
hold off
