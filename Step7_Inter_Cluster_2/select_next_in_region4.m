function [X_next,params] = select_next_in_region4(gm, X_prev, GPR, feasibility, params)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% THIS FUNCTION RETURNS THE NEXT DATAPOINT TO GO IN EACH REGION USING THE
% THE POINT WITH THE MAXIMUM VARIANCE AFTER HAVING SELECTED RANDOMLY POINTS
% IN A REGION AND PERFORMED M-STEP OF GRADIENT OF THE VARIANCE.
%
% Input: - gm             : (object) GMM model fit on task constraints
%        - X_prev         : (nb_gaussians x P) Previous goal datapoints of dimension P
%        - GPR            : (object) Gaussian Process Regressor
%        - feasibility    : (struct) Feasibility constraints of robot
%        - params         : (struct) Parameters
%
%
% Ouput: - X_next         : (nb_gaussians x P) Goal datapoints of dimension P
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

nb_gaussians = size(X_prev,1);
X_next = zeros(nb_gaussians,size(X_prev,2));

% Function that computes the Mahalanobis distance
MahaDist = @(x,idx) sqrt(diag((x-gm.mu(idx,:))*(gm.Sigma(:,:,idx)\(x-gm.mu(idx,:))')));

% Generate nb_gaussians*15 points from the GMM
[Y,compIdx] = random(gm, nb_gaussians*3*params.P);


% Select randomly a few point in each region and chose max variance
for i=1:nb_gaussians
    
    % Compute points from the region
    Y_i = Y(compIdx == i,:);
        
    % Compute M steps towards max variance from random point
    j = 1;
    nb_points = 0;
    Y_j = zeros(params.P,size(X_prev,2));
    while (nb_points < params.P) && (j <= size(Y_i,1))
        for m=1:params.M
            % Step towards maximum variance
            grad_var_j = GPR.gradient_var(Y_i(j,:));
            Y_i(j,:) = Y_i(j,:) + grad_var_j*params.robot_step;
        end
        % Check if point is in region
        Y_j_dist = MahaDist(Y_i(j,:),i);
        if Y_j_dist <= params.region_thres
            nb_points = nb_points+1;
            Y_j(nb_points,:) = Y_i(j,:);
        end
        j = j+1;
    end
    
    % Select only all non_zeros
    Y_j = Y_j(find(Y_j(:,1)~=0),:);
    
    % Compute variance of all the points
    [~, Var_j] = GPR.predict(Y_j, false);
    [~, idx] = sort(Var_j,'descend');
    
    % Assign next point
    position = 1;
    X_next(i,:) = Y_j(idx(position),:);
    
    % Make sure point is feasible
    while not(is_feasible_point(X_next(i,:),feasibility))
        position = position + 1;
        X_next(i,:) = Y_i(idx(position),:); 
    end
end
    


end